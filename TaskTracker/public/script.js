// === script.js ===

// Base URL
const BASE_URL = "https://taskmanager-m90d.onrender.com";

// --- KEY NORMALIZATION (kritik) ---
// pg -> JS d√∂n√º≈ü√ºnde gelen k√º√ß√ºk harfli alanlarƒ±, UI'nin beklediƒüi camelCase isimlere √ßeviriyoruz.
function normalizeKeys(row) {
  if (!row || typeof row !== "object") return row;
  const map = {
    // users
    fullname: "fullName",
    isadmin: "isAdmin",

    // tasks
    assignedto: "assignedTo",
    approvedat: "approvedAt",
    assignedat: "assignedAt",

    // goals/user_goals
    goalid: "goalId",

    // daily_points
    pointsearned: "pointsEarned",
  };
  const out = { ...row };
  for (const [from, to] of Object.entries(map)) {
    if (from in out && !(to in out)) {
      out[to] = out[from];
      delete out[from];
    }
  }
  return out;
}
const normalizeArray = (arr) => Array.isArray(arr) ? arr.map(normalizeKeys) : arr;

// Kullanƒ±cƒ± bilgileri ve y√∂nlendirme
const user = JSON.parse(localStorage.getItem("user"));
if (!user) location.href = "login.html";

document.getElementById("name").innerText   = user.fullName;
document.getElementById("level").innerText  = user.level;
document.getElementById("points").innerText = user.points;

// Admin panelini g√∂ster ve y√ºklemeleri yap
if (user.isAdmin) {
  document.getElementById("adminPanel").style.display = "block";
  loadUserOptions();
  loadPendingTasks();
  loadPendingGoals();
  loadActiveTasks();
}

// --- Uzun Vadeli Hedefler ---

async function loadGoals() {
  const res   = await fetch(`${BASE_URL}/goals`);
  const goals = normalizeArray(await res.json());
  const select = document.getElementById("goalSelect");
  select.innerHTML = `<option value="">Hedef Se√ß‚Ä¶</option>`;
  goals.forEach(g => {
    const opt = document.createElement("option");
    opt.value = g.id;
    opt.textContent = `${g.goal} (${g.points} puan)`;
    select.appendChild(opt);
  });
}

async function selectGoal() {
  const goalId = +document.getElementById("goalSelect").value;
  if (!goalId) return alert("L√ºtfen bir hedef se√ßin!");
  await fetch(`${BASE_URL}/addGoal`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: user.username, goalId }),
  });
  loadSelectedGoals();
}

async function loadSelectedGoals() {
  const res      = await fetch(`${BASE_URL}/selectedGoals`);
  const allGoals = normalizeArray(await res.json());
  const myList   = document.getElementById("myGoals");
  const teamList = document.getElementById("teamGoals");
  myList.innerHTML   = "";
  teamList.innerHTML = "";

  allGoals.forEach(g => {
    if (g.username === user.username) {
      const li = document.createElement("li");
      let btn = "";
      switch (g.status) {
        case "available":
          btn = `<button onclick="startGoal(${g.goalId})">Ba≈üla</button>`;
          break;
        case "in-progress":
          btn = `<button onclick="finishGoal(${g.goalId})">Bitir</button>`;
          break;
        case "pending":
          btn = `<button class="waiting" disabled>Onay Bekliyor</button>`;
          break;
        case "approved":
          btn = `<span class="approved">Tamamlandƒ±</span>`;
          break;
      }
      li.innerHTML = `${g.goal} (${g.points} puan) ${btn}`;
      myList.appendChild(li);
    } else {
      const li = document.createElement("li");
      li.innerText = `${g.goal} ‚Äî ${g.username} ‚Äî ${statusText(g.status)}`;
      teamList.appendChild(li);
    }
  });
}

async function startGoal(goalId) {
  await fetch(`${BASE_URL}/startGoal`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: user.username, goalId }),
  });
  loadSelectedGoals();
}

async function finishGoal(goalId) {
  await fetch(`${BASE_URL}/finishGoal`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: user.username, goalId }),
  });
  loadSelectedGoals();
}

function statusText(status) {
  switch (status) {
    case "available":    return "Hazƒ±r";
    case "in-progress":  return "Devam Ediyor";
    case "pending":      return "Onay Bekliyor";
    case "approved":     return "Tamamlandƒ±";
    default:             return "";
  }
}

// --- G√ºnl√ºk G√∂revler ---

async function loadTasks() {
  const res   = await fetch(`${BASE_URL}/tasks/${user.username}`);
  const tasks = normalizeArray(await res.json());
  const ul    = document.getElementById("personalTasks");
  ul.innerHTML = "";
  tasks.forEach(t => {
    const li = document.createElement("li");
    let btn = "";
    switch (t.status) {
      case "available":
        btn = `<span style="display:flex; justify-content:flex-end; gap:6px;">
                 <button onclick="startTask(${t.id})">Ba≈üla</button>
               </span>`;
        break;
      case "in-progress":
        btn = `<span style="display:flex; justify-content:flex-end; gap:6px;">
                 <button onclick="finishTask(${t.id})">Bitir</button>
               </span>`;
        break;
      case "pending":
        btn = `<button class="waiting" disabled>Onay Bekliyor</button>`;
        break;
      case "approved":
        btn = `<span class="approved">Tamamlandƒ±</span>`;
        break;
    }
    // ‚ú® assignAt bilgisini ekledim
    const dateText = t.assignedAt ? `üìÖ ${t.assignedAt.slice(0, 10)}` : "";
    li.innerHTML = `${t.title} (${t.points} puan) ${dateText} ${btn}`;
    ul.appendChild(li);
  });
}


async function assignTaskToMe() {
  const title  = document.getElementById("adminTaskSelect").value;
  const points = 0; // istersen input ekleyip puanƒ± da alabilirsin

  if (!title) return alert("G√∂rev bo≈ü olamaz!");

  // giri≈ü yapan kullanƒ±cƒ±nƒ± localStorage‚Äôdan oku
  const currentUser = JSON.parse(localStorage.getItem("user"));
  if (!currentUser) return alert("Kullanƒ±cƒ± bilgisi bulunamadƒ±!");

  try {
    const res = await fetch(`${BASE_URL}/assignTask`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        title,
        points,
        assignedTo: currentUser.username   // ‚ú® burasƒ± kritik
      }),
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data?.message || "G√∂rev atanamadƒ±");

    document.getElementById("assignMsg").innerText = "‚úîÔ∏è G√∂rev atandƒ±";
    loadTasks(); // var olan g√∂revleri yeniden y√ºkle
  } catch (e) {
    console.error(e);
    alert("G√∂rev atanamadƒ±: " + e.message);
  }
}

async function startTask(id) {
  await fetch(`${BASE_URL}/startTask`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: user.username, taskId: id }),
  });
  loadTasks();
}

async function finishTask(id) {
  await fetch(`${BASE_URL}/finishTask`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: user.username, taskId: id }),
  });
  loadTasks();
}

// --- Tamamlananlar & Lider Tablosu ---

async function loadCompleted() {
  const res  = await fetch(`${BASE_URL}/completed/${user.username}`);
  const done = normalizeArray(await res.json());
  const ul   = document.getElementById("dailyDone");
  ul.innerHTML = "";
  done.forEach(t => {
    const li = document.createElement("li");
    li.innerText = `‚úîÔ∏è ${t.title} (${t.points} puan)`;
    ul.appendChild(li);
  });
}

async function loadLeaderboard() {
  const res = await fetch(`${BASE_URL}/leaderboard`);
  const data = normalizeArray(await res.json());
  const ol = document.getElementById("leaderboard");
  ol.innerHTML = "";

  data.forEach((u, idx) => {
    const medal = idx === 0 ? "ü•á" : idx === 1 ? "ü•à" : idx === 2 ? "ü•â" : "";
    const li = document.createElement("li");
    li.textContent = `${idx + 1}. ${u.fullName} ${medal} ‚Äì ${u.points} puan (Seviye ${u.level})`;
    ol.appendChild(li);
  });
}

// --- Haftalƒ±k Performans Grafiƒüi (sadece hafta i√ßi: Pzt‚ÄìCum) ---
function ymdKey(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

async function loadWeeklyStats() {
  const canvas = document.getElementById("weeklyChart");
  if (!canvas || typeof Chart === "undefined") return;

  try {
    // Veriyi √ßek
    const res = await fetch(`${BASE_URL}/weeklyStats/${user.username}`);
    if (!res.ok) throw new Error("Haftalƒ±k istatistik alƒ±namadƒ±");
    const stats = normalizeArray(await res.json()) || [];

    // Tarih -> puan haritasƒ± (YYYY-MM-DD -> pointsEarned)
    const pointsMap = new Map();
    for (const s of stats) {
      // s.date "YYYY-MM-DD" ise doƒürudan anahtar olarak kullan
      const key = String(s.date).slice(0, 10);
      const val = Number(s.pointsEarned ?? s.points ?? 0);
      pointsMap.set(key, (pointsMap.get(key) || 0) + val);
    }

    // Bu haftanƒ±n Pazartesisini bul (Pzt=1, JS getDay: Paz=0)
    const today = new Date();
    const midnight = new Date(today.getFullYear(), today.getMonth(), today.getDate()); // 00:00
    const dow = midnight.getDay();              // 0..6  (0=Paz)
    const diffToMonday = (dow + 6) % 7;         // Pzt i√ßin 0
    const monday = new Date(midnight);
    monday.setDate(midnight.getDate() - diffToMonday);

    // Pazartesi‚ÄìCuma 5 g√ºn√º √ºret
    const weekdays = Array.from({ length: 5 }, (_, i) => {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      return d;
    });

    // Etiketler ve veri
    const labels = weekdays.map(d =>
      d.toLocaleDateString("tr-TR", { weekday: "short" }) // Pzt, Sal, √áar, Per, Cum
    );

    const data = weekdays.map(d => {
      const key = ymdKey(d);
      return pointsMap.get(key) ?? 0;
    });

    // √ñnceki grafik varsa temizle
    if (window.__weeklyChart) window.__weeklyChart.destroy();

    window.__weeklyChart = new Chart(canvas.getContext("2d"), {
      type: "bar",
      data: {
        labels,
        datasets: [{ label: "G√ºnl√ºk Puan", data, backgroundColor: "#00bfff" }],
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2,                 // geni≈ülik/y√ºkseklik oranƒ±
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: true } },
      },
    });
  } catch (e) {
    console.error(e);
  }
}


// --- Admin: G√∂rev Atama & Onaylar ---

async function loadUserOptions() {
  const res  = await fetch(`${BASE_URL}/users`);
  const list = normalizeArray(await res.json());
  const sel  = document.getElementById("assignToUser");
  sel.innerHTML = "";
  list.forEach(u => {
    const opt = document.createElement("option");
    opt.value   = u.username;
    opt.innerText = u.fullName;
    sel.appendChild(opt);
  });
}

async function assignTask() {
  const title      = document.getElementById("newTaskTitle").value;
  const points     = parseInt(document.getElementById("newTaskPoints").value) || 10;
  const assignedTo = document.getElementById("assignToUser").value;
  if (!title || !assignedTo) return alert("T√ºm alanlarƒ± doldurun!");
  await fetch(`${BASE_URL}/assignTask`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ title, points, assignedTo }),
  });
  document.getElementById("assignMessage").innerText = "‚úîÔ∏è G√∂rev atandƒ±";
  loadTasks();
}

async function loadPendingTasks() {
  const res  = await fetch(`${BASE_URL}/pendingTasks`);
  const pend = normalizeArray(await res.json());
  const ul   = document.getElementById("pendingList");
  ul.innerHTML = "";
  pend.forEach(t => {
    const li = document.createElement("li");
    li.style.display = "flex";
    li.style.alignItems = "center";
    li.style.justifyContent = "space-between";
    li.style.marginBottom = "10px";
    li.style.padding = "8px";
    li.style.background = "#eaf6ff";
    li.style.borderRadius = "6px";

    const spanText = document.createElement("span");
    spanText.textContent = `${t.title}  ‚Äî ${t.assignedTo}`;
    spanText.style.flexGrow = "1";

    const rightControls = document.createElement("div");
    rightControls.style.display = "flex";
    rightControls.style.alignItems = "center";
    rightControls.style.gap = "6px";

    const pointsInput = document.createElement("input");
    pointsInput.type = "number";
    pointsInput.min = "0";
    pointsInput.placeholder = "Puan";
    pointsInput.style.width = "60px";
    pointsInput.style.height = "30px";
    pointsInput.style.textAlign = "center";
    pointsInput.value = t.points ?? "";

    const btn = document.createElement("button");
    btn.innerText = "Onayla";
    btn.style.height = "34px";
    btn.style.backgroundColor = "#00bfff";
    btn.style.color = "white";
    btn.style.border = "none";
    btn.style.borderRadius = "4px";
    btn.style.cursor = "pointer";
    btn.onclick = () => approveTask(t.id, t.assignedTo, parseInt(pointsInput.value) || 0);

    rightControls.appendChild(pointsInput);
    rightControls.appendChild(btn);
    li.appendChild(spanText);
    li.appendChild(rightControls);
    ul.appendChild(li);
  });
}
async function loadActiveTasks() {
  const ul = document.getElementById("activeTasksList");
  if (!ul) return; // Bu sayfada deƒüilse sessiz ge√ß

  try {
    const res = await fetch(`${BASE_URL}/activeTasks`);
    if (!res.ok) throw new Error("Aktif g√∂revler alƒ±namadƒ±");
     const active = normalizeArray(await res.json());

    ul.innerHTML = "";
    if (!active.length) {
      ul.innerHTML = "<li>≈ûu anda aktif g√∂rev bulunmuyor.</li>";
      return;
    }

    active.forEach(t => {
      const durum = t.status === "in-progress" ? "Devam Ediyor" : "Ba≈ülamadƒ±";
      const li = document.createElement("li");
     // ‚ú® Tarih eklendi
    const dateText = t.assignedAt ? `üìÖ ${t.assignedAt.slice(0,10)}` : "";
    li.textContent = `${t.fullName} ‚Üí ${t.title} (${t.points} puan) [${durum}] ${dateText}`;

      ul.appendChild(li);
    });
  } catch (e) {
    console.error(e);
    ul.innerHTML = "<li>Hata: veriler alƒ±namadƒ±.</li>";
  }
}

// Onay fonksiyonu
async function approveTask(id, username, points) {
  await fetch(`${BASE_URL}/approveTask`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ taskId: id, username, points })
  });
  loadPendingTasks();
  loadTasks();
  loadCompleted();
  loadLeaderboard();
}

// --- Admin: Hedef Onayƒ± ---

async function loadPendingGoals() {
  const res  = await fetch(`${BASE_URL}/pendingGoals`);
  const pend = normalizeArray(await res.json());
  const ul   = document.getElementById("pendingGoalsList");
  ul.innerHTML = "";
  pend.forEach(g => {
    const li = document.createElement("li");
    li.innerHTML = `
      ${g.goal} (${g.points} puan) ‚Äî ${g.username}
      <button onclick="approveGoal(${g.goalId},'${g.username}')">Onayla</button>
    `;
    ul.appendChild(li);
  });
}
// --- Onaylanmƒ±≈ü G√∂revler ---
async function loadApprovedTasks() {
  const ul = document.getElementById("loadApprovedTasks");
  if (!ul) return; // sayfada yoksa bo≈ü ge√ß

  try {
    const res = await fetch(`${BASE_URL}/approvedTasks`);
    if (!res.ok) throw new Error("Onaylanmƒ±≈ü g√∂revler alƒ±namadƒ±");
    const approved = normalizeArray(await res.json());

    console.log("‚úÖ approved verisi:", approved); // Debug i√ßin

    ul.innerHTML = "";
    if (!approved.length) {
      ul.innerHTML = "<li>‚úÖ Onaylanmƒ±≈ü g√∂rev yok.</li>";
      return;
    }

    // Kullanƒ±cƒ±ya g√∂re grupla (fullname √ºzerinden)
    const grouped = {};
    approved.forEach(t => {
      if (!grouped[t.fullname]) grouped[t.fullname] = [];
      grouped[t.fullname].push(t);
    });

    for (const [who, tasks] of Object.entries(grouped)) {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${who}</strong><ul>` +
        tasks.map(t => `<li>‚Ä¢ ${t.title} (${t.points} puan)</li>`).join("") +
        `</ul>`;
      ul.appendChild(li);
    }
  } catch (e) {
    console.error(e);
    ul.innerHTML = "<li>Hata: Onaylanmƒ±≈ü g√∂revler alƒ±namadƒ±.</li>";
  }
}



async function approveGoal(goalId, who) {
  await fetch(`${BASE_URL}/approveGoal`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: who, goalId }),
  });
  loadPendingGoals();
  loadSelectedGoals();
  // Not: localStorage'daki user obje puan/level'ƒ± otomatik g√ºncellenmiyor.
  // ƒ∞stersen burada /users'tan kendi kaydƒ±nƒ± √ßekip localStorage'ƒ± g√ºncelleyebilirsin.
}

// --- ƒ∞lk y√ºklemeler ---
loadGoals();
loadSelectedGoals();
loadTasks();
loadCompleted();
loadLeaderboard();
loadWeeklyStats();
loadApprovedTasks();

